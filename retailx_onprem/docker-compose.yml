version: '3.9'

services:
  oracle-db:
    image: gvenzl/oracle-free:23
    container_name: oracle-db
    ports:
      - "1521:1521"   # Required for Databricks to connect
      - "5500:5500"
    environment:
      ORACLE_PASSWORD: ${ORACLE_PASSWORD}
      ORACLE_CHARACTERSET: AL32UTF8
    volumes:
      - oracle-data:/opt/oracle/oradata
    healthcheck:
      test: ["CMD", "bash", "-c", "echo 'select 1 from dual;' | sqlplus -s system/${ORACLE_PASSWORD}@localhost:1521/FREEPDB1 | grep -q 1"]
      interval: 20s
      timeout: 10s
      retries: 10
    networks:
      - etl-net

  etl:
    build: ./etl
    container_name: oracle-etl
    depends_on:
      oracle-db:
        condition: service_healthy
    environment:
      ORACLE_HOST: oracle-db
      ORACLE_PORT: 1521
      ORACLE_SERVICE: FREEPDB1
      ORACLE_USER: system
      ORACLE_PASSWORD: ${ORACLE_PASSWORD}
      S3_BUCKET: ${S3_BUCKET}
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
    networks:
      - etl-net
    command: ["tail", "-f", "/dev/null"]  # manual run

volumes:
  oracle-data:

networks:
  etl-net:
    driver: bridge
